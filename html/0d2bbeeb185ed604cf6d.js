var __awaiter=this&&this.__awaiter||function(e,n,t,r){return new(t||(t=Promise))((function(a,i){function s(e){try{c(r.next(e))}catch(e){i(e)}}function o(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var n;e.done?a(e.value):(n=e.value,n instanceof t?n:new t((function(e){e(n)}))).then(s,o)}c((r=r.apply(e,n||[])).next())}))},__generator=this&&this.__generator||function(e,n){var t,r,a,i,s={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]};return i={next:o(0),throw:o(1),return:o(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function o(i){return function(o){return function(i){if(t)throw new TypeError("Generator is already executing.");for(;s;)try{if(t=1,r&&(a=2&i[0]?r.return:i[0]?r.throw||((a=r.return)&&a.call(r),0):r.next)&&!(a=a.call(r,i[1])).done)return a;switch(r=0,a&&(i=[2&i[0],a.value]),i[0]){case 0:case 1:a=i;break;case 4:return s.label++,{value:i[1],done:!1};case 5:s.label++,r=i[1],i=[0];continue;case 7:i=s.ops.pop(),s.trys.pop();continue;default:if(!((a=(a=s.trys).length>0&&a[a.length-1])||6!==i[0]&&2!==i[0])){s=0;continue}if(3===i[0]&&(!a||i[1]>a[0]&&i[1]<a[3])){s.label=i[1];break}if(6===i[0]&&s.label<a[1]){s.label=a[1],a=i;break}if(a&&s.label<a[2]){s.label=a[2],s.ops.push(i);break}a[2]&&s.ops.pop(),s.trys.pop();continue}i=n.call(e,s)}catch(e){i=[6,e],r=0}finally{t=a=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,o])}}},__values=this&&this.__values||function(e){var n="function"==typeof Symbol&&Symbol.iterator,t=n&&e[n],r=0;if(t)return t.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&r>=e.length&&(e=void 0),{value:e&&e[r++],done:!e}}};throw new TypeError(n?"Object is not iterable.":"Symbol.iterator is not defined.")},log=function(){for(var e=[],n=0;n<arguments.length;n++)e[n]=arguments[n]},PREFIX="/python-wasm-sw/",VERSION=3;function delay(e){return new Promise((function(n){return setTimeout(n,e)}))}function handleSleep(e){var n;return __awaiter(this,void 0,void 0,(function(){var t,r;return __generator(this,(function(a){switch(a.label){case 0:return[4,e.request.json()];case 1:return t=a.sent(),r=null!==(n=Math.round(null==t?void 0:t.ms))&&void 0!==n?n:100,log("sleep",r),[4,delay(r)];case 2:return a.sent(),[2,new Response({status:304})]}}))}))}self.addEventListener("install",(function(e){log("install  - python-wasm service worker, version: ",VERSION,e)})),self.addEventListener("activate",(function(e){log("activate - python-wasm service worker, version: ",VERSION,e)}));var cache={sig:{},stdin:{},lastUsed:{},callOnStdin:{}};function touch(e){var n=(new Date).valueOf();for(var t in cache.lastUsed[e]=n,cache.lastUsed)n-cache.lastUsed[t]>=6e4&&(delete cache.lastUsed[t],delete cache.sig[t],delete cache.stdin[t])}function handleWriteSignal(e){return __awaiter(this,void 0,void 0,(function(){var n,t,r;return __generator(this,(function(a){switch(a.label){case 0:return[4,e.request.json()];case 1:return n=a.sent(),t=n.sig,r=n.id,log("signal",r,t),cache.sig[r]=t,[2,new Response("".concat(t),{status:200})]}}))}))}function handleReadSignal(e){var n;return __awaiter(this,void 0,void 0,(function(){var t,r,a,i;return __generator(this,(function(s){switch(s.label){case 0:return[4,e.request.json()];case 1:return t=s.sent(),r=t.clear,a=t.id,i=null!==(n=cache.sig[a])&&void 0!==n?n:0,r&&(cache.sig[a]=0),[2,new Response("".concat(i),{status:200})]}}))}))}function handleWriteStdin(e){return __awaiter(this,void 0,void 0,(function(){var n,t,r,a,i,s,o,c;return __generator(this,(function(l){switch(l.label){case 0:return[4,e.request.json()];case 1:if(n=l.sent(),t=n.data,touch(r=n.id),log("write to stdin",r,t),null==cache.stdin[r]?cache.stdin[r]=t:cache.stdin[r]+=t,null!=(a=cache.callOnStdin[r])){try{for(i=__values(a),s=i.next();!s.done;s=i.next())(0,s.value)()}catch(e){o={error:e}}finally{try{s&&!s.done&&(c=i.return)&&c.call(i)}finally{if(o)throw o.error}}cache.callOnStdin[r]=[]}return[2,new Response("".concat(cache.stdin[r].length),{status:200})]}}))}))}function handleReadStdin(e){return __awaiter(this,void 0,void 0,(function(){var n,t;return __generator(this,(function(r){switch(r.label){case 0:return[4,e.request.json()];case 1:return n=r.sent().id,log("read from stdin",n),cache.stdin[n]?[3,3]:[4,new Promise((function(e){null==cache.callOnStdin[n]?cache.callOnStdin[n]=[e]:cache.callOnStdin[n].push(e)}))];case 2:r.sent(),r.label=3;case 3:return t=cache.stdin[n],cache.stdin[n]="",[2,new Response(t,{status:200})]}}))}))}self.addEventListener("fetch",(function(e){var n=new URL(e.request.url).pathname;if(!n.startsWith(PREFIX))return!1;switch(n.slice(PREFIX.length)){case"sleep":return void e.respondWith(handleSleep(e));case"write-stdin":return void e.respondWith(handleWriteStdin(e));case"read-stdin":return void e.respondWith(handleReadStdin(e));case"write-signal":return void e.respondWith(handleWriteSignal(e));case"read-signal":return void e.respondWith(handleReadSignal(e))}}));